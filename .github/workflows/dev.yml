# main.yml
name: devEvn to server
on:
  push:
    branches: [develop]
  pull_request:
    branches: [develop]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # åˆ‡æ¢åˆ†æ”¯
      - name: åˆ‡æ¢åˆ†æ”¯ Checkout
        uses: actions/checkout@v3

      # pnpm
      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 7
          run_install: true

      # ä½¿ç”¨ node:16.14.0
      - name: åˆ‡æ¢node use Node.js 16.14.0
        uses: actions/setup-node@v3.0.0
        with:
          node-version: 16.14.0
      #ç¼“å­˜ä¾èµ–
      - name: Cache nodeModules
        uses: actions/cache@v1
        env:
          cache-name: cache-node-modules
        with:
          # éœ€è¦ç¼“å­˜çš„æ–‡ä»¶çš„è·¯å¾„
          path: ./node_modules
          # å¯¹ç¼“å­˜çš„æ–‡ä»¶æŒ‡å®šçš„å”¯ä¸€æ ‡è¯†
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('./package.json') }}
          # ç”¨äºæ²¡æœ‰å†æ‰¾ç›®æ ‡keyçš„ç¼“å­˜çš„backupé€‰é¡¹
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}-
            ${{ runner.os }}-build-
            {{ runner.os }}-
      # å®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ– pnpm install
        run: pnpm run bootstrap # å®‰è£…ä¾èµ–

      # npm build
      - name: æ‰§è¡Œæ‰“åŒ… npm build
        env:
          NODE_OPTIONS: --max_old_space_size=4096
        run: pnpm run build # æ‰§è¡Œæ‰“åŒ… |

      # npm å‹ç¼©
      - name: å‹ç¼©dist
        run: tar -zcvf release.tgz dist
      # è¿æ¥åˆ°æœåŠ¡å™¨
      # name: rsync-deployments æ˜¯é€šè¿‡sshé€šè¿‡rsyncéƒ¨ç½²ä»£ç çš„GitHubæ“ä½œ
      - name: å‘å¸ƒdevç¯å¢ƒ Deploy ğŸš€
        uses: cross-the-world/scp-pipeline@master
        env:
          WELCOME: 'ssh scp ssh pipelines'
          LASTSSH: 'Doing something after copying'
        with:
          host: ${{ secrets.SERVER_HOST }}
          user: ${{ secrets.SERVER_USER }}
          pass: ${{ secrets.SERVER_PASS }}
          remote: ${{ secrets.SERVER_DEV_DIR }} # æ”¾åˆ°æœåŠ¡å™¨ä¸ŠæŒ‡å®šæ–‡ä»¶å¤¹
          local: ./release.tgz # æ„å»ºå®Œæˆåé™æ€ç›®å½•çš„åœ°å€
          connect_timeout: 15s
